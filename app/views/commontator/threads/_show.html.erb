<%#
  Views that use this partial must supply the following variables:
  thread
  user
  page
  per_page
  show_all
%>

<% can_subscribe = thread.can_subscribe?(user)
   can_edit = thread.can_be_edited_by?(user) %>

<span id="thread-<%= thread.id %>-show-span" class="thread-show commontator-hidden">
  <%= link_to t('commontator.thread.actions.show'),
              '#',
              id: "thread-#{thread.id}-show-link",
              class: "thread-show-link" %>
</span>

<span id="thread-<%= thread.id %>-span" class="thread-span">
  <div id="thread-<%= thread.id %>-header-div" class="thread-header-div">
    <span id="thread-<%= thread.id %>-actions-span" class="thread-actions">
      <span id="thread-<%= thread.id %>-hide-span" class="thread-hide commontator-hidden">
        <%= link_to t('commontator.thread.actions.hide'),
                    '#',
                    id: "thread-#{thread.id}-hide-link",
                    class: "thread-hide-link" %>
      </span>

      &nbsp;

      <% if can_subscribe %>
        <span id="thread-<%= thread.id %>-subscription-span" class="thread-subscription">
          <%= render partial: 'commontator/subscriptions/link',
                     locals: { thread: thread,
                                  user: user } %>
        </span>
      <% end %>

      &nbsp;

      <% if can_edit %>
        <% filter_string = show_all ? 'filter' : 'show-all'
           is_closed = thread.is_closed?
           close_string = is_closed ? 'reopen' : 'close' %>

        <% if thread.is_filtered? %>
          <%= link_to t("commontator.thread.actions.#{filter_string}"),
                      commontator.thread_path(thread, show_all: (show_all ? nil : true)),
                      id: "thread-#{thread.id}-#{filter_string}-link",
                      class: "thread-#{filter_string}-link",
                      remote: true %>
          &nbsp;
        <% end %>

        <%= link_to t("commontator.thread.actions.#{close_string}"),
                    commontator.polymorphic_path([close_string, thread]),
                    confirm: (!is_closed ? t('commontator.thread.actions.confirm_close') : nil),
                    method: :put,
                    id: "thread-#{thread.id}-#{close_string}-link",
                    class: "thread-#{close_string}-link",
                    remote: true %>
      <% end %>
    </span>

    <span id="thread-<%= thread.id %>-header-span" class="thread-header-span">
      <%= t "commontator.thread.status.#{thread.is_closed? ? 'closed' : 'open'}",
            closer_name: (thread.is_closed? ? Commontator.commontator_name(thread.closer) : '') %>
    </span>
  </div>

  <% if thread.config.comment_order == :l %>
    <%= render partial: 'commontator/threads/reply',
               locals: { thread: thread, user: user, per_page: per_page } %>
  <% end %>

  <div id="thread-<%= thread.id %>-comment-list-div" class="thread-comment-list">
    <% comments = thread.paginated_comments(page, per_page, show_all) %>

    <%= render partial: 'commontator/comments/list',
               locals: { comments: comments, user: user, per_page: per_page } %>
  </div>

  <% if thread.will_paginate? %>
    <div id="thread-<%= thread.id %>-pagination-div" class="thread-pagination">
      <div id="thread-<%= thread.id %>-page-entries-info-div" class="thread-page-entries-info">
        <%= page_entries_info comments,
                              params: { controller: 'commontator/threads',
                                        action: 'show',
                                        id: thread.id,
                                        page: page,
                                        per_page: per_page } %>.
      </div>

      <div id="thread-<%= thread.id %>-will-paginate-div" class="thread-will-paginate">
        <%= will_paginate comments,
                          renderer: Commontator::LinkRenderer,
                          routes_proxy: commontator,
                          remote: true,
                          params: { controller: 'commontator/threads',
                                    action: 'show',
                                    id: thread.id,
                                    page: page,
                                    per_page: per_page } %>
      </div>
    </div>
  <% end %>

  <% if thread.config.comment_order != :l %>
    <%= render partial: 'commontator/threads/reply',
               locals: { thread: thread, user: user, per_page: per_page } %>
  <% end %>
</span>

<script type="text/javascript">
  <%= render partial: 'commontator/threads/hide_show_links.js', locals: { thread: thread } %>
</script>
